<template id="usersTemplate">
    <div class="container users-container">
        <div class="page-header">
            <h1>Gestion des Utilisateurs</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showNewUserForm()">
                    <i class="fas fa-user-plus"></i> Nouvel Utilisateur
                </button>
            </div>
        </div>

        <div class="filters">
            <div class="search-bar">
                <input type="text" id="searchUsers" placeholder="Rechercher un utilisateur..." class="form-control">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-options">
                <select id="roleFilter" class="form-control">
                    <option value="">Tous les rôles</option>
                    <option value="admin">Administrateur</option>
                    <option value="subadmin">Sous-administrateur</option>
                    <option value="user">Utilisateur</option>
                </select>
                <select id="subsiteFilter" class="form-control">
                    <option value="">Tous les sous-sites</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>

        <div class="users-grid" id="usersGrid">
            <!-- Users will be dynamically inserted here -->
            <div class="loading">Chargement des utilisateurs...</div>
        </div>

        <!-- New/Edit User Modal -->
        <div class="modal" id="userModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Nouvel Utilisateur</h3>
                    <button class="close-modal" onclick="closeUserForm()">×</button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="form-group">
                            <label for="userName">Nom complet</label>
                            <input type="text" id="userName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" class="form-control" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col">
                                <label for="userRole">Rôle</label>
                                <select id="userRole" class="form-control" required>
                                    <option value="user">Utilisateur</option>
                                    <option value="subadmin">Sous-administrateur</option>
                                    <option value="admin">Administrateur</option>
                                </select>
                            </div>
                            <div class="form-group col">
                                <label for="userSubsite">Sous-site principal</label>
                                <select id="userSubsite" class="form-control">
                                    <option value="">Aucun</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group password-group">
                            <label for="userPassword">Mot de passe</label>
                            <div class="password-input">
                                <input type="password" id="userPassword" class="form-control">
                                <button type="button" class="btn btn-icon" onclick="togglePasswordVisibility()">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Laissez vide pour conserver le mot de passe actuel
                            </small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="userActive" checked>
                                Compte actif
                            </label>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeUserForm()">Annuler</button>
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        let subsites = [];
        let currentUser = null;

        async function initializeUsers() {
            try {
                // Load users and subsites
                users = await API.getUsers();
                subsites = await API.getSubsites();

                // Populate subsite filters
                const subsiteFilter = document.getElementById('subsiteFilter');
                const userSubsite = document.getElementById('userSubsite');
                const subsiteOptions = subsites.map(site =>
                    `<option value="${site.id}">${Utils.sanitizeHTML(site.name)}</option>`
                ).join('');
                subsiteFilter.innerHTML += subsiteOptions;
                userSubsite.innerHTML += subsiteOptions;

                renderUsers();

                // Set up search and filters
                const searchInput = document.getElementById('searchUsers');
                const roleFilter = document.getElementById('roleFilter');

                const filterUsers = Utils.debounce(() => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const role = roleFilter.value;
                    const subsite = subsiteFilter.value;

                    const filtered = users.filter(user => {
                        const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                                           user.email.toLowerCase().includes(searchTerm);
                        const matchesRole = !role || user.role === role;
                        const matchesSubsite = !subsite || user.subsite_id === parseInt(subsite);
                        return matchesSearch && matchesRole && matchesSubsite;
                    });

                    renderUsers(filtered);
                }, 300);

                searchInput.addEventListener('input', filterUsers);
                roleFilter.addEventListener('change', filterUsers);
                subsiteFilter.addEventListener('change', filterUsers);

                // Set up user form
                document.getElementById('userForm').addEventListener('submit', handleUserSubmit);

            } catch (error) {
                console.error('Error initializing users:', error);
                Utils.showNotification('Erreur lors du chargement des utilisateurs', 'error');
            }
        }

        function renderUsers(filteredUsers = null) {
            const grid = document.getElementById('usersGrid');
            const usersToRender = filteredUsers || users;

            if (!usersToRender.length) {
                grid.innerHTML = '<div class="no-users">Aucun utilisateur trouvé</div>';
                return;
            }

            grid.innerHTML = usersToRender.map(user => `
                <div class="user-card ${!user.active ? 'inactive' : ''}">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-info">
                        <h3>${Utils.sanitizeHTML(user.name)}</h3>
                        <p class="user-email">${Utils.sanitizeHTML(user.email)}</p>
                        <div class="user-meta">
                            <span class="role-badge ${user.role}">
                                ${getRoleLabel(user.role)}
                            </span>
                            ${user.subsite_id ? `
                                <span class="subsite-badge">
                                    <i class="fas fa-building"></i>
                                    ${Utils.sanitizeHTML(getSubsiteName(user.subsite_id))}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-icon" onclick="editUser(${user.id})" title="Éditer">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon" onclick="toggleUserActive(${user.id})"
                                title="${user.active ? 'Désactiver' : 'Activer'}">
                            <i class="fas ${user.active ? 'fa-user-slash' : 'fa-user-check'}"></i>
                        </button>
                        <button class="btn btn-icon" onclick="resetPassword(${user.id})" title="Réinitialiser mot de passe">
                            <i class="fas fa-key"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getRoleLabel(role) {
            const labels = {
                'admin': 'Administrateur',
                'subadmin': 'Sous-administrateur',
                'user': 'Utilisateur'
            };
            return labels[role] || role;
        }

        function getSubsiteName(subsiteId) {
            const subsite = subsites.find(s => s.id === subsiteId);
            return subsite ? subsite.name : 'N/A';
        }

        window.showNewUserForm = () => {
            currentUser = null;
            document.getElementById('modalTitle').textContent = 'Nouvel Utilisateur';
            document.getElementById('userForm').reset();
            document.getElementById('userPassword').required = true;
            document.getElementById('userModal').style.display = 'block';
        };

        window.editUser = async (userId) => {
            try {
                currentUser = await API.getUser(userId);
                document.getElementById('modalTitle').textContent = 'Modifier Utilisateur';
                document.getElementById('userName').value = currentUser.name;
                document.getElementById('userEmail').value = currentUser.email;
                document.getElementById('userRole').value = currentUser.role;
                document.getElementById('userSubsite').value = currentUser.subsite_id || '';
                document.getElementById('userActive').checked = currentUser.active;
                document.getElementById('userPassword').required = false;
                document.getElementById('userModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading user:', error);
                Utils.showNotification('Erreur lors du chargement de l\'utilisateur', 'error');
            }
        };

        window.closeUserForm = () => {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
        };

        window.togglePasswordVisibility = () => {
            const input = document.getElementById('userPassword');
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        };

        async function handleUserSubmit(event) {
            event.preventDefault();

            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                subsite_id: document.getElementById('userSubsite').value || null,
                active: document.getElementById('userActive').checked
            };

            const password = document.getElementById('userPassword').value;
            if (password) {
                userData.password = password;
            }

            try {
                if (currentUser) {
                    await API.updateUser(currentUser.id, userData);
                    const index = users.findIndex(u => u.id === currentUser.id);
                    users[index] = { ...users[index], ...userData };
                    Utils.showNotification('Utilisateur mis à jour avec succès', 'success');
                } else {
                    const newUser = await API.createUser(userData);
                    users.unshift(newUser);
                    Utils.showNotification('Utilisateur créé avec succès', 'success');
                }

                renderUsers();
                closeUserForm();

            } catch (error) {
                console.error('Error saving user:', error);
                Utils.showNotification('Erreur lors de l\'enregistrement de l\'utilisateur', 'error');
            }
        }

        async function toggleUserActive(userId) {
            try {
                const user = users.find(u => u.id === userId);
                await API.updateUser(userId, { active: !user.active });

                user.active = !user.active;
                renderUsers();

                Utils.showNotification(
                    `Utilisateur ${user.active ? 'activé' : 'désactivé'} avec succès`,
                    'success'
                );

            } catch (error) {
                console.error('Error toggling user status:', error);
                Utils.showNotification('Erreur lors de la modification du statut', 'error');
            }
        }

        async function resetPassword(userId) {
            if (!confirm('Êtes-vous sûr de vouloir réinitialiser le mot de passe de cet utilisateur ?')) {
                return;
            }

            try {
                const newPassword = await API.resetUserPassword(userId);
                Utils.showNotification(
                    `Mot de passe réinitialisé avec succès. Nouveau mot de passe : ${newPassword}`,
                    'success'
                );
            } catch (error) {
                console.error('Error resetting password:', error);
                Utils.showNotification('Erreur lors de la réinitialisation du mot de passe', 'error');
            }
        }

        // Initialize users when template is loaded
        initializeUsers();
    </script>
</template>
